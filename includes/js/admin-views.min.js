/**
 * Custom js script at Add New / Edit Views screen
 *
 * @package   GravityView
 * @license   GPL2+
 * @author    Katz Web Services, Inc.
 * @link      http://gravityview.co
 * @copyright Copyright 2014, Katz Web Services, Inc.
 *
 * @since 1.0.0
 */
!function($){var e={startFreshStatus:!1,init:function(){var t=e;t.gvStartFreshButton=$('a[href="#gv_start_fresh"]'),t.gvSelectForm=$("#gravityview_form_id"),t.currentFormId=t.gvSelectForm.val(),t.toggleInitialVisibility(t),t.gvStartFreshButton.on("click",t.startFresh),t.gvSelectForm.change(t.formChange),$("#gravityview_sort_filter").insertAfter($("#gravityview_view_config")),$('a[href="#gv_switch_view"]').on("click",t.switchView),$('a[href="#gv_select_template"]').click(t.selectTemplate),$(".gv-view-types-hover").click(t.selectTemplateHover),$("a[rel*=external]").click(t.openExternalLinks),$("body").on("click",".gv-overlay",function(e){e.preventDefault(),$(".ui-dialog:visible .ui-dialog-titlebar .ui-button").click()}),$("body").on("mouseup keyup",function(e){var t=!1;"keyup"===e.type&&27==e.keyCode&&(t=!0),"mouseup"===e.type&&(!$(e.target).is(".ui-tooltip")&&!$(e.target).parents(".ui-tooltip").length>0||$(e.target).parents(".close").length>0)&&(t=!0),t&&$("a.gv-add-field[data-tooltip='active']").tooltip("close")}),$("body").on("click",".ui-tooltip-content .gv-fields",function(e){$(this).has(".field-id-all-fields").length?t.addAllFields($(this)):t.addField($(this),e)}),$("body").on("click",".gv-shortcode input",t.selectText),$("body").on("change",".gv-dialog-options input[name*=show_as_link]",t.toggleShowAsEntry),$("body").on("click","span.gv-field-controls a[href='#remove']",t.removeField),$("body").on("click","span.gv-field-controls a[href='#settings']",t.openFieldSettings),$("#gravityview_view_config").find(".hndle,.handlediv").off("click").on("click",function(e){return e.preventDefault(),!1}),$("body").on("dblclick",".gv-fields",function(e){t.openFieldSettings(e)}),$(document).on("click","#publish",t.createPresetForm)},toggleShowAsEntry:function(e){var t=$(e.target).parents(".gv-fields"),i=t.find(".gv-field-controls .dashicons-admin-links");$(e.target).is(":checked")?i.removeClass("hide-if-js"):i.addClass("hide-if-js")},selectText:function(e){return e.preventDefault(),$(this).focus().select(),!1},toggleInitialVisibility:function(e){0!==e.gvSelectForm.length&&(""===e.currentFormId?e.hideView():$("#gravityview_directory_template").val().length>0?($("#gravityview_select_template").slideUp(150),e.showViewConfig()):(e.templateFilter("custom"),e.showViewTypeMetabox()))},hideView:function(){var t=e;t.currentFormId="",$("#gravityview_view_config, #gravityview_select_template, #gravityview_sort_filter").hide()},toggleViewTypeMetabox:function(){var e=$("#gravityview_select_template");e.is(":visible")?($("a[href=#gv_switch_view]").text(function(){return $(this).attr("data-text-backup")}),e.slideUp(150)):($("a[href=#gv_switch_view]").attr("data-text-backup",function(){return $(this).text()}).text(gvGlobals.label_cancel),e.slideDown(150))},showViewTypeMetabox:function(){$("#gravityview_select_template").slideDown(150)},startFresh:function(t){t.preventDefault();var i=e;i.startFreshStatus=!0,""!==i.currentFormId&&i.gvSelectForm.length>0?i.showDialog("#gravityview_form_id_dialog"):i.startFreshContinue()},startFreshContinue:function(){var t=e;$("#gravityview_form_id_start_fresh").val("1"),$("#gravityview_form_id").val(""),$("a[href=#gv_switch_view]").hide(),t.templateFilter("preset"),t.showViewTypeMetabox(),t.hideViewConfig()},formChange:function(t){t.preventDefault();var i=e;i.startFreshStatus=!1,""!==i.currentFormId&&i.currentFormId!==$(this).val()?i.showDialog("#gravityview_form_id_dialog"):i.formChangeContinue()},formChangeContinue:function(){var t=e;""===t.gvSelectForm.val()?t.hideView():($("body").trigger("gravityview_form_change").addClass("gv-form-changed"),t.templateFilter("custom"),t.showViewTypeMetabox(),t.getAvailableFields(),t.getSortableFields(),$("a[href=#gv_switch_view]").fadeOut(150))},showDialog:function(t,i){var a=e,o=$(t),l={text:gvGlobals.label_cancel,click:function(){o.is("#gravityview_form_id_dialog")?(a.startFreshStatus=!1,a.gvSelectForm.val(a.currentFormId)):o.is("#gravityview_switch_template_dialog")&&(a.toggleViewTypeMetabox(),a.showViewConfig()),o.dialog("close")}},n={text:gvGlobals.label_continue,click:function(){o.is("#gravityview_form_id_dialog")?a.startFreshStatus?a.startFreshContinue():a.formChangeContinue():o.is("#gravityview_switch_template_dialog")&&(a.selectTemplateContinue(),a.toggleViewTypeMetabox()),o.dialog("close")}},r=[l,n];i=i||r,o.dialog({dialogClass:"wp-dialog",appendTo:o.parent(),draggable:!1,resizable:!1,width:function(){return $(window).width()>550?550:$(window).width()-10},open:function(e,t){return $('<div class="gv-overlay" />').prependTo("#wpwrap"),!0},close:function(e){e.preventDefault(),a.setCustomLabel(o),$("#wpwrap > .gv-overlay").fadeOut("fast",function(){$(this).remove()})},closeOnEscape:!0,buttons:i})},setCustomLabel:function(e){var t=$("[name*=custom_label]",e),i=$("[name*=show_label]",e).is(":checked"),a=e.parents(".gv-fields").find(".gv-field-label");a.text(t.val().length>0&&i?t.val():a.attr("data-original-title"))},getSortableFields:function(t,i){var a=e;$("#gravityview_sort_field").prop("disabled","disabled").empty().append("<option>"+gvGlobals.loading_text+"</option>");var o={action:"gv_sortable_fields_form",nonce:gvGlobals.nonce};void 0!==t&&"preset"===t?o.template_id=i:o.form_id=a.gvSelectForm.val(),$.post(ajaxurl,o,function(e){"false"!==e&&$("#gravityview_sort_field").empty().append(e).prop("disabled",null)})},switchView:function(t){t.preventDefault(),t.stopImmediatePropagation();var i=e;i.templateFilter("custom"),i.toggleViewTypeMetabox()},templateFilter:function(e){$(".gv-view-types-module").each(function(){$(this).attr("data-filter")===e?$(this).parent().show():$(this).parent().hide()})},selectTemplate:function(t){var i=e;t.preventDefault(),t.stopImmediatePropagation(),i.wantedTemplate=$(this);var a=$("#gravityview_directory_template").val(),o=i.wantedTemplate.attr("data-templateid");""===a?($("#gravityview_select_template").slideUp(150),i.selectTemplateContinue()):a!=o?i.showDialog("#gravityview_switch_template_dialog"):(i.toggleViewTypeMetabox(),i.showViewConfig())},selectTemplateContinue:function(){var t=e,i=t.wantedTemplate.attr("data-templateid");$("#gravityview_directory_template").val(i).change();var a=t.wantedTemplate.parents(".gv-view-types-module");a.parents(".gv-grid").find(".gv-view-types-module").removeClass("gv-selected"),a.addClass("gv-selected"),t.startFreshStatus?(t.getAvailableFields("preset",i),t.getPresetFields(i),t.getSortableFields("preset",i)):(t.updateActiveAreas(i),$("a[href=#gv_switch_view]").fadeIn(150),t.toggleViewTypeMetabox())},selectTemplateHover:function(e){e.preventDefault(),e.stopImmediatePropagation(),$(this).find('a[href="#gv_select_template"]').trigger("click")},openExternalLinks:function(e){return window.open(this.href),!1},previewTemplate:function(e){e.preventDefault(),e.stopImmediatePropagation();var t=$(event.currentTarget).parents(".gv-view-types-module");t.find(".gv-template-preview").dialog({dialogClass:"wp-dialog",appendTo:$("#gravityview_select_template"),width:550,open:function(){$('<div class="gv-overlay" />').prependTo("#wpwrap")},close:function(){$("#wpwrap > .gv-overlay").fadeOut("fast",function(){$(this).remove()})},closeOnEscape:!0,buttons:[{text:gvGlobals.label_close,click:function(){$(this).dialog("close")}}],close:function(){$(this).dialog("option","appendTo",t)}})},updateActiveAreas:function(t){var i=e;$("#directory-active-fields, #single-active-fields").children().remove();var a={action:"gv_get_active_areas",template_id:t,nonce:gvGlobals.nonce};$.post(ajaxurl,a,function(e){if(e){var t=$.parseJSON(e);$("#directory-header-widgets").html(t.header),$("#directory-footer-widgets").html(t.footer),$("#directory-active-fields").append(t.directory),$("#single-active-fields").append(t.single),i.showViewConfig()}})},getPresetFields:function(t){var i=e;$("#directory-active-fields, #single-active-fields").children().remove();var a={action:"gv_get_preset_fields",template_id:t,nonce:gvGlobals.nonce};$.post(ajaxurl,a,function(e){if(e){var t=$.parseJSON(e);$("#directory-header-widgets").html(t.header),$("#directory-footer-widgets").html(t.footer),$("#directory-active-fields").append(t.directory),$("#single-active-fields").append(t.single),i.showViewConfig()}})},hideViewConfig:function(){$("#gravityview_view_config,#gravityview_sort_filter").slideUp(150)},showViewConfig:function(){var t=e;$("#gravityview_view_config, #gravityview_sort_filter").slideDown(150),t.toggleDropMessage(),t.init_droppables(),t.init_tooltips()},init_tooltips:function(){var t=e;$(".gv-add-field").tooltip({content:function(){switch($(this).attr("data-objecttype")){case"field":return $("#directory-available-fields").html();break;case"widget":return $("#directory-available-widgets").html()}},close:function(e,t){$(this).attr("data-tooltip","")},open:function(e,t){$(this).attr("data-tooltip","active").attr("data-tooltip-id",$(this).attr("aria-describedby"))},closeOnEscape:!0,disabled:!0,position:{my:"center bottom",at:"center top-12"},tooltipClass:"top"}).on("mouseout focusout",function(e){e.stopImmediatePropagation()}).click(function(e){e.preventDefault(),e.stopImmediatePropagation(),$(this).tooltip("open"),$(this).attr("title","")})},getAvailableFields:function(t,i){var a=e;$("#directory-available-fields, #single-available-fields").find(".gv-fields").remove(),$("#directory-active-fields, #single-active-fields").find(".gv-fields").remove(),a.toggleDropMessage();var o={action:"gv_available_fields",nonce:gvGlobals.nonce};void 0!==t&&"preset"===t?o.template_id=i:o.form_id=a.gvSelectForm.val(),$.post(ajaxurl,o,function(e){e&&($("#directory-available-fields").append(e),$("#single-available-fields").append(e))})},addAllFields:function(e){e.siblings(".gv-fields").each(function(){$(this).trigger("click")}),$("a.gv-add-field[data-tooltip='active']").tooltip("close")},addField:function(t,i){i.preventDefault();var a=e,o=t.clone().hide(),l=t.parents(".ui-tooltip").attr("id"),n=$("#gravityview_directory_template").val(),r=t.parents(".ui-tooltip").attr("id"),s=$('a.gv-add-field[data-tooltip-id="'+r+'"]'),d={action:"gv_field_options",template:n,area:s.attr("data-areaid"),context:s.attr("data-context"),field_id:o.attr("data-fieldid"),field_label:o.find(".gv-field-label").attr("data-original-title"),field_type:s.attr("data-objecttype"),input_type:o.attr("data-inputtype"),nonce:gvGlobals.nonce};$.ajax({type:"POST",url:ajaxurl,data:d,async:!0,beforeSend:function(){a.disable_publish()},complete:function(){a.enable_publish()}}).done(function(e){o.append(e),$(".all-merge-tags").remove(),"undefined"!=typeof form&&$("body").not(".gv-form-changed")&&(window.gfMergeTags=new gfMergeTagsObj(form)),$(".gv-dialog-options",o).length>0&&$(".dashicons-admin-generic",o).removeClass("hide-if-js"),$('a[data-tooltip-id="'+l+'"]').parents(".gv-droppable-area").find(".active-drop").append(o).end().attr("data-tooltip-id",""),o.fadeIn(100)}).fail(function(e,t,i){a.enable_publish(),alert(gvGlobals.field_loaderror),console.log(e)}).always(function(){a.toggleDropMessage()})},enable_publish:function(){$("#publishing-action #publish").prop("disabled",null).removeClass("button-primary-disabled")},disable_publish:function(){$("#publishing-action #publish").prop("disabled","disabled").addClass("button-primary-disabled")},init_droppables:function(){var t=e;$("#directory-fields, #single-fields").find(".active-drop-widget").sortable({placeholder:"fields-placeholder",items:"> .gv-fields",distance:2,revert:75,connectWith:".active-drop-widget",receive:function(e,i){var a=i.sender.attr("data-areaid"),o=$(this).attr("data-areaid");i.item.find('[name^="widgets['+a+']"]').each(function(){var e=$(this).attr("name");$(this).attr("name",e.replace(a,o))}),t.toggleDropMessage()}}),$("#directory-fields, #single-fields").find(".active-drop-field").sortable({placeholder:"fields-placeholder",items:"> .gv-fields",distance:2,revert:75,connectWith:".active-drop-field",receive:function(e,i){if(i.item.find(".gv-dialog-options").length>0){var a=i.sender.attr("data-areaid"),o=$(this).attr("data-areaid");i.item.find('[name^="fields['+a+']"]').each(function(){var e=$(this).attr("name");$(this).attr("name",e.replace(a,o))})}t.toggleDropMessage()}})},toggleDropMessage:function(){$(".active-drop").each(function(){$(this).find(".gv-fields").length>0?$(this).find(".drop-message").hide():$(this).find(".drop-message").fadeIn(100)})},removeField:function(t){t.preventDefault();var i=e,a=$(t.currentTarget).parents(".active-drop");if(t.altKey&&$(a).find(".gv-fields").length>1){var o=window.confirm(gvGlobals.remove_all_fields);return void(o&&($(a).find(".gv-fields").remove(),i.toggleDropMessage()))}$(t.currentTarget).parents(".gv-fields").fadeOut("normal",function(){$(this).remove(),i.toggleDropMessage()})},openFieldSettings:function(t){t.preventDefault();var i,a=e;i=$(t.currentTarget).is(".gv-fields")?$(t.currentTarget):$(t.currentTarget).parents(".gv-fields"),a.updateVisibilitySettings(t,!0),$("body").on("change",".gv-fields input:checkbox",a.updateVisibilitySettings);var o=[{text:gvGlobals.label_close,click:function(){$(this).dialog("close")}}];a.showDialog(i.find(".gv-dialog-options"),o)},updateVisibilitySettings:function(t,i){var a=e;i=i||!1,$parent=$(t.currentTarget).is(".gv-fields")?$(t.currentTarget):$(t.currentTarget).parents(".gv-fields"),a.toggleVisibility($("input:checkbox[name*=show_label]",$parent),$("[name*=custom_label]",$parent),i),a.toggleVisibility($("input:checkbox[name*=emailmailto]",$parent),$("[name*=emailsubject],[name*=emailbody]",$parent),i),a.toggleVisibility($("input:checkbox[name*=link_to_source]",$parent),$("[name*=source_link_text]",$parent),i),$("input:checkbox",$parent).attr("disabled",null),$("input:checkbox[name*=show_as_link]",$parent).is(":checked")&&$("input:checkbox[name*=link_to_]",$parent).attr("disabled",!0),$("input:checkbox[name*=link_to_]:checked",$parent).length>0&&$("input:checkbox[name*=show_as_link]",$parent).attr("disabled",!0),a.toggleVisibility($("input:checkbox[name*=only_loggedin]",$parent),$("[name*=only_loggedin_cap]",$parent),i)},toggleVisibility:function(e,t,i){var a=i?0:"fast";e.is(":checked")?t.parents("li").fadeIn(a):t.parents("li").fadeOut(a)},createPresetForm:function(){var t=e,i=$("#gravityview_directory_template").val();if(!t.startFreshStatus||""===i)return!0;var a={action:"gv_set_preset_form",template_id:i,nonce:gvGlobals.nonce};return $.post(ajaxurl,a,function(e){"false"!=e?(t.startFreshStatus=!1,t.gvSelectForm.find("option:selected").removeAttr("selected"),t.gvSelectForm.append(e),$("#publish").trigger("click")):$("#post").before('<div id="message" class="error below-h2"><p>'+gvGlobals.label_publisherror+"</p></div>")}),!1}};$(document).ready(function(){$("#title-prompt-text").text(gvGlobals.label_viewname),e.init(),$(".gv-datepicker").datepicker({dateFormat:"yy-mm-dd",constrainInput:!1});var t="gv-active-tab-"+$("#post_ID").val(),i=$.cookie(t);"undefined"===i&&(i=0),$("#gv-view-configuration-tabs").tabs({active:i,activate:function(e,i){$.cookie(t,i.newTab.index(),{path:gvGlobals.cookiepath})}}),$("#gravityview_template_settings .form-table tr:even").addClass("alternate")})}(jQuery);