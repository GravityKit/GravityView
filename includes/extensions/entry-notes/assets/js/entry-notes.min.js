!function($){var gv_notes={selectors:{wrapper:".gv-notes",bulk_form:".gv-notes-list",bulk_toggle:".gv-notes-toggle",bulk_checkbox:'input[name="note[]"]',bulk_submit:".gv-notes-delete",add_note_form:"form.gv-note-add",add_note_submit:".gv-add-note-submit",add_note_content:"textarea[name=gv-note-content]",email_wrapper:".gv-note-email-container",email_to_wrapper:".gv-note-to-container",email_select:".gv-note-email-to",email_to_custom_wrapper:".gv-note-to-custom-container"},init:function(){$(gv_notes.selectors.wrapper).each(function(){gv_notes.setup_checkboxes($(this)),$(gv_notes.selectors.bulk_toggle,$(this)).on("change",gv_notes.toggle_all),$(gv_notes.selectors.bulk_form,$(this)).on("submit",gv_notes.delete_notes),$(gv_notes.selectors.email_select,$(this)).on("change",gv_notes.email_fields_toggle).trigger("change"),$(gv_notes.selectors.add_note_form,$(this)).on("submit",gv_notes.add_note).find("textarea").on("keydown",gv_notes.command_enter)})},setup_checkboxes:function($container){$(gv_notes.selectors.bulk_checkbox,$container).on("change",gv_notes.toggle_disable_delete).shiftSelectable().filter(":first-child").trigger("change")},toggle_disable_delete:function(){$container=$(this).parents(gv_notes.selectors.wrapper),$checkboxes=$(gv_notes.selectors.bulk_checkbox,$container),$(gv_notes.selectors.bulk_submit,$container).prop("disabled",0===$checkboxes.filter(":checked").length)},email_fields_toggle:function(e){var val=$(this).val(),e=$(e.target).parents(gv_notes.selectors.wrapper).find(gv_notes.selectors.email_wrapper);$(gv_notes.selectors.email_to_wrapper,e).toggle(""!==val),$(gv_notes.selectors.email_to_custom_wrapper,e).toggle("custom"===val)},command_enter:function(e){13==e.keyCode&&e.metaKey&&$(e.currentTarget).parents("form.gv-note-add").submit()},toggle_all:function(e){$container=$(this).parents(gv_notes.selectors.wrapper),($checkboxes=$(gv_notes.selectors.bulk_checkbox,$container)).prop("checked",$(this).prop("checked")).trigger("change")},delete_notes:function(e){e.preventDefault();var $submit,$container=$(e.target).parent(gv_notes.selectors.wrapper),$checked=$(gv_notes.selectors.bulk_checkbox,$container).filter(":checked");return 0===$checked.length?(console.log("No notes were checked"),!1):window.confirm(GVNotes.text.delete_confirm)?($submit=$container.find(gv_notes.selectors.bulk_submit),void $.ajax({url:GVNotes.ajaxurl,isLocal:!0,method:"POST",beforeSend:function(){$container.addClass("gv-processing-note"),$submit.data("value",$submit.html()).prop("disabled",!0).html(GVNotes.text.processing)},data:{action:"gv_delete_notes",data:$(this).serialize()}}).done(function(data,textStatus,jqXHR){$submit.prop("disabled",!1).html($submit.data("value")),$container.removeClass("gv-processing-note"),!0===data.success?$checked.parents("tr.gv-note").addClass("gv-note-deleted").animate({height:"0",opacity:"0"},"slow",function(){$(this).remove(),0===$("tr.gv-note",$container).length&&$container.removeClass("gv-has-notes").addClass("gv-no-notes"),$container.find(gv_notes.selectors.bulk_toggle).prop("checked",!1),gv_notes.setup_checkboxes($container)}):gv_notes.show_message($submit,data.data.error)})):(console.log("Just kidding. Please do not delete me!"),!1)},show_message:function($insert_after,message,is_error){var css_class="gv-note-message",is_error=!1===is_error?"gv-note-success":"gv-note-error";($message=$insert_after.next("."+css_class).length?$insert_after.next("."+css_class):$("<div/>",{class:css_class})).insertAfter($insert_after).attr("class",css_class+" "+is_error).html(message).fadeIn("fast").delay(3e3).fadeOut("fast").on("click",function(){$(this).fadeOut("fast")})},add_note:function(e){e.preventDefault();var $container=$(e.target).parent(gv_notes.selectors.wrapper),$submit=$container.find(gv_notes.selectors.add_note_submit),$inputs=$container.find(":input").not("[type=hidden]");if(""!==$container.find(gv_notes.selectors.add_note_content).val().trim())return $.ajax({url:GVNotes.ajaxurl,isLocal:!0,method:"POST",beforeSend:function(){$container.addClass("gv-processing-note"),$inputs.prop("disabled","disabled"),$submit.data("value",$submit.html()).html(GVNotes.text.processing)},data:{action:"gv_note_add",data:$(this).serialize()}}).done(function(data,textStatus,jqXHR){$submit.html($submit.data("value")),$inputs.prop("disabled",!1),$container.removeClass("gv-processing-note"),!0===data.success?($container.removeClass("gv-no-notes").addClass("gv-has-notes"),$(data.data.html).hide().appendTo($("table tbody",$container)).fadeIn(),gv_notes.setup_checkboxes($container),$inputs.val("").trigger("change"),gv_notes.show_message($submit,GVNotes.text.note_added,!1)):gv_notes.show_message($submit,data.data.error)}),!1;gv_notes.show_message($submit,GVNotes.text.error_empty_note)}};$.fn.shiftSelectable=function(){var lastChecked,$boxes=this;return $boxes.click(function(evt){var end;lastChecked=(lastChecked&&evt.shiftKey&&(evt=$boxes.index(this),end=$boxes.index(lastChecked),$boxes.slice(Math.min(evt,end),Math.max(evt,end)+1).prop("checked",lastChecked.checked).trigger("change")),this)}),this},gv_notes.init(),window.gvEntryNotes=gv_notes}(jQuery);