!function($){var gvSearchWidget={selectFields:null,init:function(){var gvsw=gvSearchWidget;$("body").on("click",'h5.field-id-search_bar a[href="#settings"]',gvsw.openDialog),$("body").on("click",".gv-dialog-options a[href='#addSearchField']",gvsw.addField),$("body").on("click",".gv-dialog-options a[href='#removeSearchField']",gvsw.removeField),$("body").on("change",".gv-dialog-options select.gv-search-fields",gvsw.updateRow),$("body").on("dialogbeforeclose",".gv-dialog-options",gvsw.updateOnClose),$("#gravityview_form_id, #gravityview_directory_template").change(gvsw.clearCache)},openDialog:function(e){var gvsw=gvSearchWidget;e.preventDefault(),gvsw.renderUI($(this).parents(".gv-fields"))},addField:function(e){e.preventDefault();var gvsw=gvSearchWidget,table=$(this).parents("table"),row=$(this).parents("tr");row.hasClass("no-search-fields")&&(row.remove(),row=null),table.find("tr.no-search-fields").remove(),gvsw.addRow(table,row,null)},removeField:function(e){e.preventDefault();var gvsw=gvSearchWidget,table=$(this).parents("table");$(this).parents("tr").fadeTo(600,.4,function(){$(this).remove(),$("tr.gv-search-field-row",table).length<1&&$("tr.no-search-fields",table).length<1&&gvsw.addEmptyMsg(table)})},renderUI:function(parent){var gvsw=gvSearchWidget,fields=$(".gv-search-fields-value",parent).val(),dialog=$(".gv-dialog-options",parent);return null===gvsw.selectFields?(dialog.append('<p id="gv-loading">'+gvGlobals.loading_text+"</p>"),void gvsw.getSelectFields(parent)):void($("table",dialog).length&&$("#gv-loading").length<1||(table=gvsw.addTable(),""===fields||"[]"===fields?gvsw.addRow(table,null,null):gvsw.populateRows(table,fields),dialog.append(table),dialog.find("table tbody").sortable(),$("#gv-loading").remove()))},populateRows:function(table,fields){var gvsw=gvSearchWidget,rows=$.parseJSON(fields),pos=null;$.each(rows,function(i,values){gvsw.addRow(table,pos,values),pos=table.find("tbody tr:last")})},addTable:function(){return $('<table cellpading="0" cellspacing="0" border="0"><thead><tr><th>&nbsp;</th><th>'+gvSearchVar.label_searchfield+"</th><th>"+gvSearchVar.label_inputtype+"</th><th>&nbsp;</th></tr></thead><tbody></tbody></table>")},addEmptyMsg:function(table){$(table).append('<tr class="no-search-fields"><td colspan="4">&nbsp;'+gvSearchVar.label_nofields+'&nbsp;&nbsp;<a href="#addSearchField">'+gvSearchVar.label_addfield+"</a></td></tr>")},addRow:function(table,row,curr){var gvsw=gvSearchWidget,rowString='<tr class="gv-search-field-row new-row hide-if-js"><td><span class="icon gv-icon-caret-up-down"></span></td><td>'+gvsw.selectFields+'</td><td class="row-inputs"><select class="gv-search-inputs"></select></td><td class="row-options"><a href="#addSearchField" class="dashicons dashicons-plus-alt"></a><a href="#removeSearchField" class="dashicons dashicons-dismiss"></a></td></tr>';null!==row&&row.length?$(row,table).after(rowString):$("tbody",table).append(rowString),table.find("tr.new-row").each(function(){$(this).removeClass("new-row"),null!==curr&&$(this).find("select.gv-search-fields").val(curr.field),gvsw.updateSelectInput($(this)),null!==curr&&$(this).find("select.gv-search-inputs").val(curr.input),$(this).fadeTo(600,1,function(){$(this).removeClass("hide-if-js")})})},updateRow:function(){var row=$(this).parents("tr");gvSearchWidget.updateSelectInput(row)},updateSelectInput:function(tr){var gvsw=gvSearchWidget,type=tr.find("select.gv-search-fields option:selected").attr("data-type"),select=tr.find("select.gv-search-inputs"),options=gvsw.getSelectInput(type);select.html(options),"text"===type||"date"===type?select.prop("disabled",!0):select.prop("disabled",!1)},getSelectFields:function(parent){var gvsw=gvSearchWidget;$.ajax({url:ajaxurl,type:"POST",async:!0,dataType:"html",data:{action:"gv_searchable_fields",nonce:gvSearchVar.nonce,formid:$("#gravityview_form_id").val(),template_id:$("#gravityview_directory_template").val()},success:function(response){"0"!==response&&(gvsw.selectFields=response,gvsw.renderUI(parent))}})},getSelectInput:function(type){var types=$.parseJSON(gvSearchVar.inputs),options="",list=types.text;return"multi"===type?list=types.multi:"date"===type&&(list=types.date),$.each(list,function(key,label){options+='<option value="'+key+'">'+label+"</option>"}),options},updateOnClose:function(){var dialog=$(this),configs=[];dialog.find("table tr.gv-search-field-row").each(function(){var row={};row.field=$(this).find("select.gv-search-fields").val(),row.input=$(this).find("select.gv-search-inputs").val(),configs.push(row)}),$(".gv-search-fields-value",dialog).val(JSON.stringify(configs))},clearCache:function(){gvSearchWidget.selectFields=null,$(".gv-search-fields-value").each(function(){$(this).parents(".gv-dialog-options").find("table").remove(),$(this).val("")})}};$(document).ready(function(){gvSearchWidget.init()})}(jQuery);