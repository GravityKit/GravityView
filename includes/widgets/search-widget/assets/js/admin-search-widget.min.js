!function($){var gvSearchWidget={wrapClass:null,widgetTarget:$(".gv-dialog-options"),selectFields:null,wp_widget_id:"gravityview_search",default_search_fields:'[{"field":"search_all","input":"input_text"}]',init:function(wrapClass){gvSearchWidget.wrapClass=wrapClass;var wp_widget_id=gvSearchWidget.wp_widget_id;$("body").on("dialogopen",'[data-fieldid="search_bar"] .'+wrapClass,gvSearchWidget.openDialog).bind("click.widgets-toggle",gvSearchWidget.openWidget).on("click","."+wrapClass+" .gv-add-search-field",gvSearchWidget.addField).on("click","."+wrapClass+" .gv-remove-search-field",gvSearchWidget.removeField).on("change","."+wrapClass+" select.gv-search-fields",gvSearchWidget.updateRow).on("change","."+wrapClass+" select.gv-search-inputs",gvSearchWidget.toggleSearchMode).on("sortcreate sortupdate sort","."+wrapClass+" table",gvSearchWidget.zebraStripe).on("dialogbeforeclose",'[data-fieldid="search_bar"] .'+wrapClass,gvSearchWidget.updateOnClose).on("click",".widget[id*='"+wp_widget_id+"'] input.widget-control-save",gvSearchWidget.saveWidget).on("change","#gravityview_form_id",gvSearchWidget.clearViewSearchData).on("change","#gravityview_view_id",gvSearchWidget.clearWidgetSearchData),$(document).on("widget-added widget-updated",gvSearchWidget.refreshWidget).on("submit","form#post",gvSearchWidget.updateOnClose)},resetWidgetTarget:function(obj){gvSearchWidget.widgetTarget=obj.closest("div.widget").find("div."+gvSearchWidget.wrapClass),gvSearchWidget.selectFields=null},resetWidgetData:function(obj){gvSearchWidget.resetWidgetTarget(obj),$("table",gvSearchWidget.widgetTarget).remove()},openWidget:function(e){var widget,widgetId,target=$(e.target);target.parents(".widget-top").length&&!target.parents("#available-widgets").length&&(e.preventDefault(),widget=$(e.target).closest("div.widget"),widgetId=widget.attr("id"),!widget.hasClass("open")&&widgetId.indexOf(gvSearchWidget.wp_widget_id)>0&&(gvSearchWidget.resetWidgetData(target),gvSearchWidget.renderUI(widget)))},refreshWidget:function(e,widget){$(widget).hasClass("open")&&(gvSearchWidget.widgetTarget=$(widget).find("div."+gvSearchWidget.wrapClass),gvSearchWidget.renderUI(widget))},openDialog:function(e){e.preventDefault(),gvSearchWidget.widgetTarget=$(this),gvSearchWidget.renderUI($(this).parents(".gv-fields"))},addField:function(e){e.preventDefault(),"gv-widget-search-fields"===gvSearchWidget.wrapClass&&gvSearchWidget.resetWidgetTarget($(this));var table=$(this).parents("table"),row=$(this).parents("tr");return row.hasClass("no-search-fields")&&(row.remove(),row=null),gvSearchWidget.addRow(table,row,null),!1},removeField:function(e){e.preventDefault();var table=$(this).parents("table");return $(this).parents("tr").fadeTo(100,.4,function(){$(this).remove(),$("tr.gv-search-field-row",table).length<1&&$("tr.no-search-fields",table).length<1&&gvSearchWidget.addEmptyMsg(table),gvSearchWidget.updateAvailableFields(),gvSearchWidget.styleRow(table)}),!1},renderUI:function(parent){var fields=$(".gv-search-fields-value",parent).val();if(""!==$("#gravityview_view_id",parent).val()&&($gvloading=$("#gv-loading"),!($("table",gvSearchWidget.widgetTarget).length&&$gvloading.length<1||$gvloading&&$gvloading.attr("gv-error")))){if(null===gvSearchWidget.selectFields||0===$gvloading.length)return gvSearchWidget.widgetTarget.append('<p id="gv-loading"><span class="spinner"></span>'+gvGlobals.loading_text+"</p>"),void gvSearchWidget.getSelectFields(parent);table=gvSearchWidget.addTable(),fields&&0===fields.length?gvSearchWidget.addRow(table,null,null):gvSearchWidget.populateRows(table,fields),gvSearchWidget.widgetTarget.is(".gv-widget-search-fields")?gvSearchWidget.widgetTarget.append(table):gvSearchWidget.widgetTarget.find(".gv-setting-container-search_fields").after(table),gvSearchWidget.toggleSearchMode(),gvSearchWidget.widgetTarget.find("table tbody").sortable({start:function(event,ui){$(ui.item).removeClass("alt")}}),gvSearchWidget.updateAvailableFields(),$gvloading.remove()}},zebraStripe:function(){$(gvSearchWidget.widgetTarget).find("tr.gv-search-field-row").removeClass("alt").filter(":even").addClass("alt")},populateRows:function(table,fields){var rows=JSON.parse(fields),pos=null;if(!rows||0===rows.length)return void gvSearchWidget.addEmptyMsg(table);$.each(rows,function(i,values){gvSearchWidget.addRow(table,pos,values),pos=table.find("tbody tr:last")})},addTable:function(){return $('<table class="form-table widefat"><thead><tr><th class="cell-sort">&nbsp;</th><th class="cell-search-fields" scope="col">'+gvSearchVar.label_searchfield+'</th><th class="cell-input-label" scope="col">'+gvSearchVar.label_label+'</th><th class="cell-input-types" scope="col">'+gvSearchVar.label_inputtype+'</th><th class="cell-add-remove">&nbsp;</th></tr></thead><tbody></tbody></table>')},addEmptyMsg:function(table){$(table).append('<tr class="no-search-fields"><td colspan="5">'+gvSearchVar.label_nofields+'&nbsp; <button class="button button-primary button-large gv-add-search-field">'+gvSearchVar.label_addfield+"</button></td></tr>")},addRow:function(table,row,curr){var rowString=$('<tr class="gv-search-field-row new-row hide-if-js" />').append('<td class="cell-sort"><span class="icon gv-icon-caret-up-down" style="display:none;" aria-label="'+gvGlobals.label_reorder_search_fields+'" /></td>').append('<td class="cell-search-fields">'+gvSearchWidget.getSelectFields()+"</td>").append('<td class="cell-input-label"><input type="text" class="widefat gv-search-labels" /></td>').append('<td class="cell-input-types"><select class="gv-search-inputs" /></td>').append('<td class="cell-add-remove"><button class="gv-add-search-field" aria-label="'+gvGlobals.label_add_search_field+'"><span class="dashicons dashicons-plus-alt"></span></button><button class="gv-remove-search-field" aria-label="'+gvGlobals.label_remove_search_field+'"><span class="dashicons dashicons-dismiss"></span></button></td>');null!==row&&row.length?$(row,table).after(rowString):$("tbody",table).append(rowString),table.find("tr.new-row").each(function(){$(this).removeClass("new-row"),null!==curr&&$(this).find("select.gv-search-fields").val(curr.field),null!==curr&&$(this).find(".cell-input-label input").val(curr.label),gvSearchWidget.updateSelectInput($(this)),gvSearchWidget.updatePlaceholder($(this)),null!==curr&&$(this).find("select.gv-search-inputs").val(curr.input),$(this).show().removeClass("hide-if-js")}),gvSearchWidget.styleRow(table)},updatePlaceholder:function($row){var $label_input=$row.find(".cell-input-label input"),$placeholder_option=$row.find("select.gv-search-fields option").filter(":selected"),placeholder_text=$placeholder_option.attr("data-placeholder")?$placeholder_option.attr("data-placeholder"):$placeholder_option.text();$label_input.attr("placeholder",placeholder_text)},toggleSearchMode:function(){var table_row_count=$("tbody tr",gvSearchWidget.widgetTarget).length,$search_mode=$('input[name*="search_mode"]',gvSearchWidget.widgetTarget),$search_mode_container=$search_mode.parents(".gv-setting-container");$('option:selected[value="date_range"]',gvSearchWidget.widgetTarget).length>0?($search_mode.filter(":checked").not(":disabled").attr("data-original-value",function(){return $(this).attr("value")}),$search_mode.val(["all"]),$search_mode_container.find(":input").attr("disabled","disabled")):($search_mode_container.find(":input").attr("disabled",null),$search_mode.filter("[data-original-value]").val(function(){return $(this).prop("checked",!0),[$(this).attr("value")]})),table_row_count>1?$search_mode_container.show():$search_mode_container.hide(100)},styleRow:function(table){table_row_count=$("tbody tr",table).length;var sort_icon=$(".cell-sort .icon",table);gvSearchWidget.toggleSearchMode(),table_row_count<=1?(sort_icon.hide(),$(this).parents("td").addClass("no-sort")):(sort_icon.show(),$(this).parents("td").removeClass("no-sort")),gvSearchWidget.zebraStripe()},updateRow:function(e){var $row=$(this).parents("tr");gvSearchWidget.updateSelectInput($row),gvSearchWidget.updateAvailableFields(),gvSearchWidget.updatePlaceholder($row)},updateAvailableFields:function(){$("option",gvSearchWidget.selectFields).attr("disabled",null),$("tr.gv-search-field-row .gv-search-fields",gvSearchWidget.widgetTarget).each(function(){gvSearchWidget.selectFields.find('option[value="'+$(this).val()+'"]').attr("disabled",!0)}).each(function(){var select=gvSearchWidget.selectFields.clone();select.val($(this).val()),select.find("option:selected").attr("disabled",null),$(this).replaceWith(select)})},updateSelectInput:function(tr){var type=tr.find("select.gv-search-fields option:selected").attr("data-inputtypes"),select=tr.find("select.gv-search-inputs"),options=gvSearchWidget.getSelectInput(type);select.html(options),select.prop("disabled",function(){return 1===$("option",$(this)).length})},getSelectFields:function(parent){if(null!==gvSearchWidget.selectFields)return gvSearchWidget.updateAvailableFields(),gvSearchWidget.selectFields.prop("outerHTML");var fields=gvSearchWidget.widgetTarget.data("gvSelectFields");if(void 0!==fields)return gvSearchWidget.selectFields=$(fields),gvSearchWidget.updateAvailableFields(),$("table",gvSearchWidget.widgetTarget).length?gvSearchWidget.selectFields.prop("outerHTML"):void gvSearchWidget.renderUI(parent);var ajaxdata={action:"gv_searchable_fields",nonce:gvSearchVar.nonce,formid:$("#gravityview_form_id").val(),view_id:$("#gravityview_view_id",parent).val(),template_id:$("#gravityview_directory_template").val()};$.ajax({url:ajaxurl,type:"POST",async:!0,dataType:"html",data:ajaxdata,success:function(response){"0"!==response?(gvSearchWidget.selectFields=$(response),gvSearchWidget.widgetTarget.data("gvSelectFields",response),gvSearchWidget.renderUI(parent)):($(parent).find(".gv-setting-container").hide(),$("#gv-loading").text(gvSearchVar.label_ajaxerror).attr("gv-error",1))}})},getSelectInput:function(type){var labels=JSON.parse(gvSearchVar.input_labels),types=JSON.parse(gvSearchVar.input_types),options=[],inputs=gvSearchWidget.getValue(types,type);return null===inputs?"":($.each(inputs,function(k,input){var label=gvSearchWidget.getValue(labels,input);options.push('<option value="'+input+'">'+label+"</option>")}),options.join())},getValue:function(obj,key){var value=null;return $.each(obj,function(k,val){if(key===k)return value=val,!1}),value},saveWidget:function(){gvSearchWidget.resetWidgetTarget($(this)),gvSearchWidget.updateOnClose()},updateOnClose:function(e){var configs=[];$('input[name*="search_mode"]',gvSearchWidget.widgetTarget).attr("disabled",null),gvSearchWidget.widgetTarget.find("table tr.gv-search-field-row").each(function(){var row={field:$(this).find("select.gv-search-fields").val(),input:$(this).find("select.gv-search-inputs").val(),label:$(this).find("input.gv-search-labels").val()};configs.push(row)}),$(".gv-search-fields-value",gvSearchWidget.widgetTarget).val(JSON.stringify(configs))},clearViewSearchData:function(){gvSearchWidget.selectFields=null,$(".gv-search-fields-value").each(function(){$(this).parents("."+gvSearchWidget.wrapClass).find("table").remove(),$(this).val(gvSearchWidget.default_search_fields)})},clearWidgetSearchData:function(){gvSearchWidget.resetWidgetData($(this)),gvSearchWidget.widgetTarget.removeData("gvSelectFields"),$(".gv-search-fields-value",gvSearchWidget.widgetTarget).val(gvSearchWidget.default_search_fields);var widget=gvSearchWidget.widgetTarget.closest("div.widget");$(".hide-on-view-change:visible",widget).slideUp(100),""!==$(this).val()&&gvSearchWidget.renderUI(widget)}};$(document).ready(function(){var contextClass=$("body").hasClass("widgets-php")?"gv-widget-search-fields":"gv-dialog-options";gvSearchWidget.init(contextClass)})}(jQuery);