!function($){var DBG=function(){if(window.gvDebugKeyboardNav){var args=Array.prototype.slice.call(arguments);args.unshift("[GV KB]");try{console.log.apply(console,args)}catch(e){}}};function enableKeyboardClass(){$("body").hasClass("gv-using-keyboard")||($("body").addClass("gv-using-keyboard"),DBG("enable keyboard class"))}function disableKeyboardClass(){$("body").removeClass("gv-using-keyboard"),DBG("disable keyboard class")}function getContainer($field){return $field.closest(".active-drop-field, .active-drop-widget, .active-drop-search")}function updateButtons($field){var $siblings=getContainer($field).children(".gv-fields"),index=$siblings.index($field),$up=$field.find(".gv-move-up"),$field=$field.find(".gv-move-down"),atTop=index<=0,atBottom=index===$siblings.length-1;$up.attr("aria-hidden",atTop?"true":"false").toggle(!atTop),$field.attr("aria-hidden",atBottom?"true":"false").toggle(!atBottom),DBG("updateButtons",{index:index,len:$siblings.length,atTop:atTop,atBottom:atBottom})}function ensureFocus($el){var attempts,tryFocus;$el&&$el.length&&(attempts=0,(tryFocus=function(){if(attempts++,!$el.is(":visible"))return attempts<5?setTimeout(tryFocus,0):void 0;try{$el[0].focus({preventScroll:!0})}catch(e){$el.trigger("focus")}var ok=document.activeElement===$el[0];DBG("ensureFocus attempt",attempts,ok,$el[0]),!ok&&attempts<5&&setTimeout(tryFocus,0)})())}function move($field,delta,preferred,$usedBtn){if($field&&$field.length){var $container=getContainer($field);if($container.length){var $container=$container.children(".gv-fields"),newIndex=$container.index($field)+(delta<0?-1:1);if(!(newIndex<0||newIndex>=$container.length)){var $focused=$(document.activeElement),hadFocusInside=$.contains($field[0],$focused[0]);DBG("move start",{delta:delta,preferred:preferred}),delta<0?$field.prev(".gv-fields").before($field):$field.next(".gv-fields").after($field);try{window.viewConfiguration&&"function"==typeof viewConfiguration.setUnsavedChanges&&viewConfiguration.setUnsavedChanges(!0)}catch(e){}setTimeout(function(){var $t;enableKeyboardClass(),function($field){if($field&&$field.length)try{$field.attr("tabindex","-1"),$field[0].focus({preventScroll:!0}),DBG("focused container"),setTimeout(function(){$field.removeAttr("tabindex")},250)}catch(e){}}($field),updateButtons($field),function($field){try{var $siblings=getContainer($field).children(".gv-fields"),index=$siblings.index($field),$status=$("#gv-reorder-status");($status=0===$status.length?$("<div/>",{id:"gv-reorder-status",class:"screen-reader-text","aria-live":"polite",role:"status"}).appendTo(document.body):$status).text("Moved to position "+(index+1)+" of "+$siblings.length+".")}catch(e){}}($field),$usedBtn&&$usedBtn.length&&$usedBtn.is(":visible")?(DBG("refocus used button"),ensureFocus($usedBtn)):function($field,preferred){var $btn=$field.find("up"===preferred?".gv-move-up":".gv-move-down").filter(":visible");return($btn=$btn.length?$btn:$field.find("up"===preferred?".gv-move-down":".gv-move-up").filter(":visible")).length&&($btn.trigger("focus"),1)}($field,preferred)||(DBG("used button hidden; fallback"),hadFocusInside&&$focused&&$focused.length&&$.contains($field[0],$focused[0])?ensureFocus($focused):($t=$field.find('.gv-move-up:visible, .gv-move-down:visible, button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])').filter(":visible").first()).length&&ensureFocus($t)),DBG("activeElement",document.activeElement)},0)}}}}$(function(){$(window).on("keydown.gvKeyboardNav",function(e){e=e.key||e.keyCode;"Tab"!==e&&9!==e&&"ArrowUp"!==e&&38!==e&&"ArrowDown"!==e&&40!==e||enableKeyboardClass()}),$(window).on("mousedown.gvKeyboardNav touchstart.gvKeyboardNav",disableKeyboardClass),$(document.body).on("click",".gv-move-up",function(e){var $btn=$(this);$btn.data("gv-skip-click")?($btn.removeData("gv-skip-click"),e.preventDefault(),e.stopPropagation()):(e.preventDefault(),e.stopPropagation(),enableKeyboardClass(),move($btn.closest(".gv-fields"),-1,"up",$btn))}).on("click",".gv-move-down",function(e){var $btn=$(this);$btn.data("gv-skip-click")?($btn.removeData("gv-skip-click"),e.preventDefault(),e.stopPropagation()):(e.preventDefault(),e.stopPropagation(),enableKeyboardClass(),move($btn.closest(".gv-fields"),1,"down",$btn))}).on("keydown",".gv-field-reorder button",function(e){var $btn=$(this),isUp=$btn.hasClass("gv-move-up");$btn.hasClass("gv-move-down");" "===e.key||32===e.keyCode||"Enter"===e.key||13===e.keyCode?(e.preventDefault(),e.stopPropagation(),enableKeyboardClass(),$btn.data("gv-skip-click",!0),setTimeout(function(){$btn.removeData("gv-skip-click")},250),isUp?move($btn.closest(".gv-fields"),-1,"up",$btn):move($btn.closest(".gv-fields"),1,"down",$btn)):"ArrowUp"===e.key||38===e.keyCode?(e.preventDefault(),enableKeyboardClass(),move($btn.closest(".gv-fields"),-1,"up",$btn)):"ArrowDown"!==e.key&&40!==e.keyCode||(e.preventDefault(),enableKeyboardClass(),move($btn.closest(".gv-fields"),1,"down",$btn))}).on("keydown",".gv-fields",function(e){"ArrowUp"===e.key||38===e.keyCode?(e.preventDefault(),move($(this),-1,"up")):"ArrowDown"!==e.key&&40!==e.keyCode||(e.preventDefault(),move($(this),1,"down"))}).on("focusin",".gv-fields",function(){updateButtons($(this))})})}(jQuery);