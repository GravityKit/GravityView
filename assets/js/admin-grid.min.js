($=>{let activateGrid=selector=>{$(selector).find(".gv-grid > .gv-grid-rows-container").each((i,grid)=>{var options={handle:"> .gv-grid-row-actions > .gv-grid-row-handle",items:"> .gv-grid-row.is-sortable",distance:2,revert:75,placeholder:"grid-row-placeholder",forcePlaceholderSize:!0,receive:function(event,ui){let sender_area=ui.sender.closest(".gv-grid").data("grid-context"),receiver_area=$(this).closest(".gv-grid").data("grid-context");ui.item.attr("data-context",receiver_area),ui.item.find("[data-context]").attr("data-context",receiver_area),ui.item.find("[data-areaid]").attr("data-areaid",(_,area_id)=>area_id.replace(sender_area+"_",receiver_area+"_")),ui.item.find('[name*="['+sender_area+'_"]').each(function(){var name=$(this).attr("name");$(this).attr("name",name.replace("["+sender_area+"_","["+receiver_area+"_"))}),refreshRowReorderButtons($(this)),ui.sender&&ui.sender.length&&refreshRowReorderButtons(ui.sender)}};let connectWith=$(grid).closest(".gv-grid").data("grid-connect");options.start=(event,ui)=>{ui.item.data("gv-original-container",getRowContainer(ui.item)),void 0!==connectWith&&$(selector).find('[data-grid-connect="'+connectWith+'"]').addClass("is-receivable")},options.stop=(event,ui)=>{void 0!==connectWith&&$(selector).find('[data-grid-connect="'+connectWith+'"]').removeClass("is-receivable");var ui=ui.item,$newContainer=getRowContainer(ui),$original=ui.data("gv-original-container");refreshRowReorderButtons($newContainer),$original&&$original.length&&!$original.is($newContainer)&&refreshRowReorderButtons($original),ui.removeData("gv-original-container"),markUnsavedChanges()},void 0!==connectWith&&(options.connectWith='[data-grid-connect="'+connectWith+'"] > .gv-grid-rows-container'),$(grid).sortable(options),refreshRowReorderButtons($(grid))})},setAddRowState=($container,isOpen)=>{$container.toggleClass("open",isOpen),$container.find(".gv-toggle").attr("aria-expanded",isOpen),$container.find(".gv-grid-row-layouts-wrapper").attr("aria-hidden",!isOpen);$container=$container.find("[data-add-row]");isOpen?$container.each((_,option)=>{option.removeAttribute("tabindex")}):$container.attr("tabindex",-1)},lastInteractionWasKeyboard=!1,getRowContainer=$row=>$row.closest(".gv-grid-rows-container"),markUnsavedChanges=()=>{window?.viewConfiguration?.setUnsavedChanges?.(!0)},ensureFocus=$element=>{if(!$element||0===$element.length)return!1;if(window?.viewConfiguration?.ensureFocus)window.viewConfiguration.ensureFocus($element);else try{$element[0].focus({preventScroll:!0})}catch(error){$element.trigger("focus")}return document.activeElement===$element[0]},focusRowContainer=$row=>{if($row&&0!==$row.length){try{$row.attr("tabindex","-1"),$row[0].focus({preventScroll:!0})}catch(error){$row.trigger("focus")}setTimeout(()=>{$row.removeAttr("tabindex")},250)}},focusRowControl=($row,preferred)=>{if($row&&0!==$row.length){var selectors="up"===preferred?[".gv-grid-row-move-up:visible",".gv-grid-row-move-down:visible"]:[".gv-grid-row-move-down:visible",".gv-grid-row-move-up:visible"];selectors.push(".gv-grid-row-handle:visible"),selectors.push(".gv-grid-row-delete:visible");for(let i=0;i<selectors.length;i++){var $target=$row.find(selectors[i]).first();if($target.length&&ensureFocus($target))return!0}}return!1},announceRowMove=$row=>{var $container=getRowContainer($row);if($container.length){$container=$container.children(".gv-grid-row"),$row=$container.index($row);if(-1!==$row){let $status=$("#gv-reorder-status");($status=$status.length?$status:$("<div>",{id:"gv-reorder-status",class:"screen-reader-text","aria-live":"polite",role:"status"}).appendTo(document.body)).text("Row moved to position "+($row+1)+" of "+$container.length+".")}}},updateRowReorderButtons=$row=>{var $down,$handle,hasMultipleRows,atTop,index,$up,$container=getRowContainer($row);$container.length&&(atTop=(index=($container=$container.children(".gv-grid-row")).index($row))<=0,index=index===$container.length-1,$container=$container.length<=1,$up=$row.find(".gv-grid-row-move-up"),$down=$row.find(".gv-grid-row-move-down"),$handle=$row.find(".gv-grid-row-handle"),atTop=(hasMultipleRows=!$container)&&!atTop,index=hasMultipleRows&&!index,$up.attr("aria-hidden",hasMultipleRows?"false":"true").attr("aria-disabled",(!atTop).toString()).prop("disabled",!atTop).attr("tabindex",atTop?0:-1).toggle(hasMultipleRows),$down.attr("aria-hidden",hasMultipleRows?"false":"true").attr("aria-disabled",(!index).toString()).prop("disabled",!index).attr("tabindex",index?0:-1).toggle(hasMultipleRows),$handle.length)&&($up=$container||$row.hasClass("is-keyboard-nav"),$handle.attr("aria-hidden",$up?"true":"false"),$up?$handle.attr("tabindex",-1).hide():$handle.removeAttr("tabindex").show())},refreshRowReorderButtons=$container=>{$container&&$container.length&&$container.children(".gv-grid-row").each((_,row)=>{updateRowReorderButtons($(row))})},moveRow=($row,direction,preferred,$trigger=void 0)=>{if($row&&$row.length){let $container=getRowContainer($row);if($container.length){var $rows=$container.children(".gv-grid-row"),targetIndex=$rows.index($row)+(direction<0?-1:1);if(!(targetIndex<0||targetIndex>=$rows.length)){let $focused=$(document.activeElement),hadFocusInside=$focused.length&&$.contains($row[0],$focused[0]);direction<0?$row.prev(".gv-grid-row").before($row):$row.next(".gv-grid-row").after($row),markUnsavedChanges(),setTimeout(()=>{var $fallback;focusRowContainer($row),refreshRowReorderButtons($container),announceRowMove($row),$trigger&&$trigger.length&&$trigger.is(":visible")&&ensureFocus($trigger)||focusRowControl($row,preferred)||hadFocusInside&&$focused.length&&ensureFocus($focused)||($fallback=$row.find('.gv-grid-row-move-up:visible:not([disabled]), .gv-grid-row-move-down:visible:not([disabled]), .gv-grid-row-handle:visible, .gv-grid-row-delete:visible, button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])').filter(":visible").first()).length&&ensureFocus($fallback)},0)}}}};$(()=>{activateGrid(document),$(".gv-grid-add-row").each((_,element)=>{element=$(element);setAddRowState(element,element.hasClass("open"))}),void 0!==window?.gvAdminActions&&(window.gvAdminActions.activateGrid=activateGrid),$(document).on("keydown.gv-grid-input",event=>{["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","Enter"," "].includes(event.key)&&(lastInteractionWasKeyboard=!0)}).on("pointerdown.gv-grid-input mousedown.gv-grid-input touchstart.gv-grid-input",event=>{lastInteractionWasKeyboard=!1;event=$(event.target).closest(".gv-grid-row");event.length&&(event.removeClass("is-keyboard-nav"),updateRowReorderButtons(event))}).on("click",".gv-grid-row-delete",function(){let $row=$(this).closest(".gv-grid-row"),$fields=$row.find(".gv-fields"),$container=getRowContainer($row);0<$fields.length&&!confirm($(this).data("confirm"))||$row.fadeOut("fast",()=>{$fields.each(function(){$(this).remove(),$(document.body).trigger("gravityview/field-removed",$(this))}),$row.remove(),refreshRowReorderButtons($container),markUnsavedChanges(),$(document.body).trigger("gravityview/row-removed",$row)})}).on("click",".gv-grid-row-move-up",function(e){var $button=$(this);$button.data("gv-skip-click")?($button.removeData("gv-skip-click"),e.preventDefault(),e.stopPropagation()):(e.preventDefault(),e.stopPropagation(),ensureFocus($button),moveRow($button.closest(".gv-grid-row"),-1,"up",$button))}).on("click",".gv-grid-row-move-down",function(e){var $button=$(this);$button.data("gv-skip-click")?($button.removeData("gv-skip-click"),e.preventDefault(),e.stopPropagation()):(e.preventDefault(),e.stopPropagation(),ensureFocus($button),moveRow($button.closest(".gv-grid-row"),1,"down",$button))}).on("keydown",".gv-grid-row-move-up, .gv-grid-row-move-down",function(e){let $button=$(this);var direction=$button.hasClass("gv-grid-row-move-up")?-1:1,preferred=direction<0?"up":"down";" "===e.key||32===e.keyCode||"Enter"===e.key||13===e.keyCode?(e.preventDefault(),e.stopPropagation(),$button.data("gv-skip-click",!0),setTimeout(()=>{$button.removeData("gv-skip-click")},250),moveRow($button.closest(".gv-grid-row"),direction,preferred,$button)):"ArrowUp"===e.key||38===e.keyCode?(e.preventDefault(),moveRow($button.closest(".gv-grid-row"),-1,"up",$button)):"ArrowDown"!==e.key&&40!==e.keyCode||(e.preventDefault(),moveRow($button.closest(".gv-grid-row"),1,"down",$button))}).on("keydown",".gv-grid-row-handle",function(e){var $handle=$(this);"ArrowUp"===e.key||38===e.keyCode?(e.preventDefault(),moveRow($handle.closest(".gv-grid-row"),-1,"up",$handle)):"ArrowDown"!==e.key&&40!==e.keyCode||(e.preventDefault(),moveRow($handle.closest(".gv-grid-row"),1,"down",$handle))}).on("keydown",".gv-grid-row",function(e){e.target===this&&("ArrowUp"===e.key||38===e.keyCode?(e.preventDefault(),moveRow($(this),-1,"up")):"ArrowDown"!==e.key&&40!==e.keyCode||(e.preventDefault(),moveRow($(this),1,"down")))}).on("focusin",".gv-grid-row",function(){var $row=$(this);lastInteractionWasKeyboard&&$row.addClass("is-keyboard-nav"),refreshRowReorderButtons(getRowContainer($row))}).on("focusout",".gv-grid-row",function(event){var $row=$(this);$row[0]===event.target&&0<$row.has(event.relatedTarget).length||$.contains(this,event.relatedTarget)||($row.removeClass("is-keyboard-nav"),updateRowReorderButtons($row))}).on("click",".gv-grid-add-row .gv-toggle",function(e){var $add_row=$(this).closest(".gv-grid-add-row"),isOpen=!$add_row.hasClass("open");setAddRowState($add_row,isOpen)}).on("click",".gv-grid-add-row [data-add-row]",function(e){var $add_row_button=$(this);let $add_row=$(this).closest(".gv-grid-add-row"),zone=$add_row_button.data("add-row"),template_id=$add_row_button.data("template-id"),type=$add_row_button.data("type"),row_type=$add_row_button.data("row-type");$.post(ajaxurl,{action:"gv_create_row",template_id:template_id,nonce:gvGlobals.nonce,zone:zone,type:type,row_type:row_type,dataType:"json"}).always(()=>{setAddRowState($add_row,!1)}).done(response=>{var response=JSON.parse(response),response=$(response?.row),$container=$add_row.closest(".gv-grid").find("> .gv-grid-rows-container");response.appendTo($container),$(document.body).trigger("gravityview/row-added",response,{type:type,row_type:row_type,zone:zone,template_id:template_id}),window?.gvAdminActions?.initTooltips(),window?.gvAdminActions?.initDroppables(response),refreshRowReorderButtons($container),focusRowControl(response,"down"),markUnsavedChanges()})})})})(jQuery);