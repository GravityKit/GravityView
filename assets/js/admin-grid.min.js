(e=>{const t=t=>{e(t).find(".gv-grid > .gv-grid-rows-container").each(((r,o)=>{let d={handle:"> .gv-grid-row-actions > .gv-grid-row-handle",items:"> .gv-grid-row.is-sortable",distance:2,revert:75,placeholder:"grid-row-placeholder",forcePlaceholderSize:!0,receive:function(t,r){const o=r.sender.closest(".gv-grid").data("grid-context"),i=e(this).closest(".gv-grid").data("grid-context");r.item.attr("data-context",i),r.item.find("[data-context]").attr("data-context",i),r.item.find("[data-areaid]").attr("data-areaid",((e,t)=>t.replace(o+"_",i+"_"))),r.item.find('[name*="['+o+'_"]').each((function(){const t=e(this).attr("name");e(this).attr("name",t.replace("["+o+"_","["+i+"_"))})),s(e(this)),r.sender&&r.sender.length&&s(r.sender)}},a=e(o).closest(".gv-grid").data("grid-connect");d.start=(r,o)=>{o.item.data("gv-original-container",i(o.item)),void 0!==a&&e(t).find('[data-grid-connect="'+a+'"]').addClass("is-receivable")},d.stop=(r,o)=>{void 0!==a&&e(t).find('[data-grid-connect="'+a+'"]').removeClass("is-receivable");const d=o.item,g=i(d),c=d.data("gv-original-container");s(g),c&&c.length&&!c.is(g)&&s(c),d.removeData("gv-original-container"),n()},void 0!==a&&(d.connectWith='[data-grid-connect="'+a+'"] > .gv-grid-rows-container'),e(o).sortable(d),s(e(o))}))},r=(e,t)=>{e.toggleClass("open",t),e.find(".gv-toggle").attr("aria-expanded",t),e.find(".gv-grid-row-layouts-wrapper").attr("aria-hidden",!t);const r=e.find("[data-add-row]");t?r.each(((e,t)=>{t.removeAttribute("tabindex")})):r.attr("tabindex",-1)};let o=!1;const i=e=>e.closest(".gv-grid-rows-container"),n=()=>{window?.viewConfiguration?.setUnsavedChanges?.(!0)},d=e=>{if(!e||0===e.length)return!1;if(window?.viewConfiguration?.ensureFocus)return window.viewConfiguration.ensureFocus(e),document.activeElement===e[0];try{e[0].focus({preventScroll:!0})}catch(t){e.trigger("focus")}return document.activeElement===e[0]},a=(e,t)=>{if(!e||0===e.length)return!1;const r="up"===t?[".gv-grid-row-move-up:visible",".gv-grid-row-move-down:visible"]:[".gv-grid-row-move-down:visible",".gv-grid-row-move-up:visible"];r.push(".gv-grid-row-handle:visible"),r.push(".gv-grid-row-delete:visible");for(let t=0;t<r.length;t++){const o=e.find(r[t]).first();if(o.length&&d(o))return!0}return!1},g=e=>{const t=i(e);if(!t.length)return;const r=t.children(".gv-grid-row"),o=r.index(e),n=o<=0,d=o===r.length-1,a=r.length<=1,g=e.find(".gv-grid-row-move-up"),s=e.find(".gv-grid-row-move-down"),c=e.find(".gv-grid-row-handle"),v=!a&&!n,l=!a&&!d;if(g.attr("aria-hidden",v?"false":"true").attr("aria-disabled",(!v).toString()).prop("disabled",!v).attr("tabindex",v?0:-1).toggle(v),s.attr("aria-hidden",l?"false":"true").attr("aria-disabled",(!l).toString()).prop("disabled",!l).attr("tabindex",l?0:-1).toggle(l),c.length){const t=a||e.hasClass("is-keyboard-nav");c.attr("aria-hidden",t?"true":"false"),t?c.attr("tabindex",-1).hide():c.removeAttr("tabindex").show()}},s=t=>{t&&t.length&&t.children(".gv-grid-row").each(((t,r)=>{g(e(r))}))},c=(t,r,o,g=void 0)=>{if(!t||!t.length)return;const c=i(t);if(!c.length)return;const v=c.children(".gv-grid-row"),l=v.index(t)+(r<0?-1:1);if(l<0||l>=v.length)return;const w=e(document.activeElement),u=w.length&&e.contains(t[0],w[0]);r<0?t.prev(".gv-grid-row").before(t):t.next(".gv-grid-row").after(t),n(),setTimeout((()=>{if((e=>{if(e&&0!==e.length){try{e.attr("tabindex","-1"),e[0].focus({preventScroll:!0})}catch(t){e.trigger("focus")}setTimeout((()=>{e.removeAttr("tabindex")}),250)}})(t),s(c),(t=>{const r=i(t);if(!r.length)return;const o=r.children(".gv-grid-row"),n=o.index(t);if(-1===n)return;let d=e("#gv-reorder-status");d.length||(d=e("<div>",{id:"gv-reorder-status",class:"screen-reader-text","aria-live":"polite",role:"status"}).appendTo(document.body)),d.text("Row moved to position "+(n+1)+" of "+o.length+".")})(t),g&&g.length&&g.is(":visible")&&d(g))return;if(a(t,o))return;if(u&&w.length&&d(w))return;const r=t.find('.gv-grid-row-move-up:visible:not([disabled]), .gv-grid-row-move-down:visible:not([disabled]), .gv-grid-row-handle:visible, .gv-grid-row-delete:visible, button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])').filter(":visible").first();!r.length||d(r)}),0)},v=()=>{e(document).on("keydown.gv-grid-input",(e=>{["Tab","ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End","Enter"," "].includes(e.key)&&(o=!0)})).on("pointerdown.gv-grid-input mousedown.gv-grid-input touchstart.gv-grid-input",(t=>{o=!1;const r=e(t.target).closest(".gv-grid-row");r.length&&(r.removeClass("is-keyboard-nav"),g(r))})).on("click",".gv-grid-row-delete",(function(){const t=e(this).closest(".gv-grid-row"),r=t.find(".gv-fields"),o=i(t);r.length>0&&!confirm(e(this).data("confirm"))||t.fadeOut("fast",(()=>{r.each((function(){e(this).remove(),e(document.body).trigger("gravityview/field-removed",e(this))})),t.remove(),s(o),n(),e(document.body).trigger("gravityview/row-removed",t)}))})).on("click",".gv-grid-row-move-up",(function(t){const r=e(this);if(r.data("gv-skip-click"))return r.removeData("gv-skip-click"),t.preventDefault(),void t.stopPropagation();t.preventDefault(),t.stopPropagation(),d(r),c(r.closest(".gv-grid-row"),-1,"up",r)})).on("click",".gv-grid-row-move-down",(function(t){const r=e(this);if(r.data("gv-skip-click"))return r.removeData("gv-skip-click"),t.preventDefault(),void t.stopPropagation();t.preventDefault(),t.stopPropagation(),d(r),c(r.closest(".gv-grid-row"),1,"down",r)})).on("keydown",".gv-grid-row-move-up, .gv-grid-row-move-down",(function(t){const r=e(this),o=r.hasClass("gv-grid-row-move-up")?-1:1,i=o<0?"up":"down";if(" "===t.key||32===t.keyCode||"Enter"===t.key||13===t.keyCode)return t.preventDefault(),t.stopPropagation(),r.data("gv-skip-click",!0),setTimeout((()=>{r.removeData("gv-skip-click")}),250),void c(r.closest(".gv-grid-row"),o,i,r);"ArrowUp"===t.key||38===t.keyCode?(t.preventDefault(),c(r.closest(".gv-grid-row"),-1,"up",r)):"ArrowDown"!==t.key&&40!==t.keyCode||(t.preventDefault(),c(r.closest(".gv-grid-row"),1,"down",r))})).on("keydown",".gv-grid-row-handle",(function(t){const r=e(this);"ArrowUp"===t.key||38===t.keyCode?(t.preventDefault(),c(r.closest(".gv-grid-row"),-1,"up",r)):"ArrowDown"!==t.key&&40!==t.keyCode||(t.preventDefault(),c(r.closest(".gv-grid-row"),1,"down",r))})).on("keydown",".gv-grid-row",(function(t){t.target===this&&("ArrowUp"===t.key||38===t.keyCode?(t.preventDefault(),c(e(this),-1,"up")):"ArrowDown"!==t.key&&40!==t.keyCode||(t.preventDefault(),c(e(this),1,"down")))})).on("focusin",".gv-grid-row",(function(){const t=e(this);o&&t.addClass("is-keyboard-nav"),s(i(t))})).on("focusout",".gv-grid-row",(function(t){const r=e(this);r[0]===t.target&&r.has(t.relatedTarget).length>0||e.contains(this,t.relatedTarget)||(r.removeClass("is-keyboard-nav"),g(r))})).on("click",".gv-grid-add-row .gv-toggle",(function(t){const o=e(this).closest(".gv-grid-add-row"),i=!o.hasClass("open");r(o,i)})).on("click",".gv-grid-add-row [data-add-row]",(function(t){const o=e(this),i=e(this).closest(".gv-grid-add-row"),d=o.data("add-row"),g=o.data("template-id"),c=o.data("type"),v=o.data("row-type");e.post(ajaxurl,{action:"gv_create_row",template_id:g,nonce:gvGlobals.nonce,zone:d,type:c,row_type:v,dataType:"json"}).always((()=>{r(i,!1)})).done((t=>{const r=JSON.parse(t),o=e(r?.row),l=i.closest(".gv-grid").find("> .gv-grid-rows-container");o.appendTo(l),e(document.body).trigger("gravityview/row-added",o,{type:c,row_type:v,zone:d,template_id:g}),window?.gvAdminActions?.initTooltips(),window?.gvAdminActions?.initDroppables(o),s(l),a(o,"down"),n()}))}))};e((()=>{t(document),e(".gv-grid-add-row").each(((t,o)=>{const i=e(o);r(i,i.hasClass("open"))})),void 0!==window?.gvAdminActions&&(window.gvAdminActions.activateGrid=t),v()}))})(jQuery);